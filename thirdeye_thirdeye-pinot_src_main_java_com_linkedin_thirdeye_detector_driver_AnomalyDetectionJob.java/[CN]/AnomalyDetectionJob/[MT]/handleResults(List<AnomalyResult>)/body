{
  Session session=sessionFactory.openSession();
  try {
    ManagedSessionContext.bind(session);
    Transaction transaction=session.beginTransaction();
    try {
      for (      AnomalyResult result : results) {
        AnomalyFunctionSpec spec=anomalyFunction.getSpec();
        result.setFunctionId(spec.getId());
        result.setFunctionType(spec.getType());
        result.setFunctionProperties(spec.getProperties());
        result.setCollection(spec.getCollection());
        result.setMetric(spec.getMetric());
        result.setFilters(spec.getFilters());
        result.setScore(normalize(result.getScore()));
        result.setWeight(normalize(result.getWeight()));
        resultDAO.createOrUpdate(result);
      }
      transaction.commit();
    }
 catch (    Exception e) {
      transaction.rollback();
      throw new RuntimeException(e);
    }
  }
  finally {
    session.close();
    ManagedSessionContext.unbind(sessionFactory);
  }
}
