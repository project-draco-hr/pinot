{
  CollectionSchema schema=dataCache.getCollectionSchema(collection);
  DateTime baseline=new DateTime(baselineMillis);
  DateTime current=new DateTime(currentMillis);
  LOGGER.info("Request uri: {}",uriInfo.getRequestUri());
  Map<String,Multimap<String,String>> reverseDimensionGroups=null;
  DimensionGroupSpec dimensionGroupSpec=configCache.getDimensionGroupSpec(collection);
  if (dimensionGroupSpec != null) {
    reverseDimensionGroups=dimensionGroupSpec.getReverseMapping();
  }
switch (dimensionViewType) {
case CONTRIBUTOR:
case MULTI_TIME_SERIES:
    List<String> viewDimensions=dashboardConfigResource.getDimensions(collection,uriInfo);
  return contributorResource.generateDimensionContributorView(collection,metricFunction,selectedDimensions,viewDimensions,baseline,current,reverseDimensionGroups);
case HEAT_MAP:
Map<String,List<Future<QueryResult>>> resultActualFutures=new HashMap<>();
Multimap<String,String> expandedDimensionValues=ThirdEyeRequestUtils.expandDimensionGroups(selectedDimensions,reverseDimensionGroups);
ThirdEyeMetricFunction thirdEyeMetricFunction=ThirdEyeMetricFunction.fromStr(metricFunction);
long bucketSize=thirdEyeMetricFunction.getTimeGranularity().toMillis();
DateTime baselineStart=baseline;
DateTime baselineEnd=baseline.plus(bucketSize);
DateTime currentStart=current;
DateTime currentEnd=current.plus(bucketSize);
for (String dimension : schema.getDimensions()) {
if (!selectedDimensions.containsKey(dimension)) {
ThirdEyeRequest baseLineReq=new ThirdEyeRequestBuilder().setCollection(collection).setMetricFunction(thirdEyeMetricFunction).setDimensionValues(expandedDimensionValues).setGroupBy(dimension).setStartTimeInclusive(baselineStart).setEndTime(baselineEnd).setTopCount(HEATMAP_GROUP_COUNT).build();
ThirdEyeRequest currentReq=new ThirdEyeRequestBuilder().setCollection(collection).setMetricFunction(thirdEyeMetricFunction).setDimensionValues(expandedDimensionValues).setGroupBy(dimension).setTopCount(HEATMAP_GROUP_COUNT).setStartTimeInclusive(currentStart).setEndTime(currentEnd).build();
ArrayList<Future<QueryResult>> futures=new ArrayList<>();
futures.add(queryCache.getQueryResultAsync(baseLineReq));
futures.add(queryCache.getQueryResultAsync(currentReq));
LOGGER.info("Generated request for heat map, dimension: {}, request: {}",dimension,baseLineReq);
LOGGER.info("Generated request for heat map: dimension: {}, request: {}",dimension,currentReq);
resultActualFutures.put(dimension,futures);
}
}
List<Future<QueryResult>> resultFuturesForTotal=new ArrayList<>(2);
ThirdEyeRequest baselineReqForTotal=new ThirdEyeRequestBuilder().setCollection(collection).setMetricFunction(thirdEyeMetricFunction).setDimensionValues(expandedDimensionValues).setStartTimeInclusive(baselineStart).setEndTime(baselineEnd).build();
ThirdEyeRequest currentReqForTotal=new ThirdEyeRequestBuilder().setCollection(collection).setMetricFunction(thirdEyeMetricFunction).setDimensionValues(expandedDimensionValues).setStartTimeInclusive(currentStart).setEndTime(currentEnd).build();
LOGGER.info("Generated Total request for heat map: {}",baselineReqForTotal);
LOGGER.info("Generated Total request for heat map: {}",currentReqForTotal);
resultFuturesForTotal.add(queryCache.getQueryResultAsync(baselineReqForTotal));
resultFuturesForTotal.add(queryCache.getQueryResultAsync(currentReqForTotal));
Map<String,Map<String,String>> dimensionGroups=null;
Map<String,Map<Pattern,String>> dimensionRegex=null;
DimensionGroupSpec groupSpec=configCache.getDimensionGroupSpec(collection);
if (groupSpec != null) {
dimensionGroups=groupSpec.getMapping();
dimensionRegex=groupSpec.getRegexMapping();
}
Map<String,QueryResult> actualResults=QueryUtils.waitForAndMergeMultipleResults(resultActualFutures);
QueryResult resultForTotal=QueryUtils.waitForAndMergeMultipleResults(resultFuturesForTotal);
DimensionViewHeatMap dimensionViewHeatMap=new DimensionViewHeatMap(schema,objectMapper,actualResults,dimensionGroups,dimensionRegex,baseline,current,resultForTotal);
return dimensionViewHeatMap;
case TABULAR:
List<FunnelTable> funnelTables=funnelResource.computeFunnelViews(collection,metricFunction,funnels,baselineMillis,currentMillis,selectedDimensions);
return new DimensionViewFunnel(funnelTables);
default :
throw new NotFoundException("No dimension view implementation for " + dimensionViewType);
}
}
