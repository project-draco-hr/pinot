{
  Map<String,Map<Long,StarTreeRecord>> records=StarTreeJobUtils.aggregateRecords(config,avroRecords,numTimeBuckets);
  LOG.info("Writing {} aggregate records to {}",records.size(),nodeId.toString());
  List<StarTreeRecord> mergedRecords=new ArrayList<StarTreeRecord>();
  for (  Map<Long,StarTreeRecord> timeBucket : records.values()) {
    for (    Map.Entry<Long,StarTreeRecord> entry : timeBucket.entrySet()) {
      mergedRecords.add(entry.getValue());
    }
  }
  int nextValueId=StarTreeConstants.FIRST_VALUE;
  Map<String,Map<String,Integer>> forwardIndex=new HashMap<String,Map<String,Integer>>();
  for (  StarTreeRecord record : mergedRecords) {
    for (    String dimensionName : config.getDimensionNames()) {
      Map<String,Integer> forward=forwardIndex.get(dimensionName);
      if (forward == null) {
        forward=new HashMap<String,Integer>();
        forward.put(StarTreeConstants.STAR,StarTreeConstants.STAR_VALUE);
        forward.put(StarTreeConstants.OTHER,StarTreeConstants.OTHER_VALUE);
        forwardIndex.put(dimensionName,forward);
      }
      String dimensionValue=record.getDimensionValues().get(dimensionName);
      Integer valueId=forward.get(dimensionValue);
      if (valueId == null) {
        forward.put(dimensionValue,nextValueId++);
      }
    }
  }
  ByteArrayOutputStream entryStream=new ByteArrayOutputStream();
  DataOutputStream dos=new DataOutputStream(entryStream);
  byte[] nodeIdBytes=nodeId.toString().getBytes(Charset.forName("UTF-8"));
  dos.writeInt(nodeIdBytes.length);
  dos.write(nodeIdBytes);
  byte[] indexBytes=OBJECT_MAPPER.writeValueAsBytes(forwardIndex);
  dos.writeInt(indexBytes.length);
  dos.write(indexBytes);
  ByteArrayOutputStream bufferStream=new ByteArrayOutputStream();
  StarTreeRecordStoreCircularBufferImpl.fillBuffer(bufferStream,config.getDimensionNames(),config.getMetricNames(),forwardIndex,mergedRecords,numTimeBuckets,true);
  byte[] bufferBytes=bufferStream.toByteArray();
  dos.writeInt(bufferBytes.length);
  dos.write(bufferBytes);
  dos.flush();
  context.write(NullWritable.get(),new BytesWritable(entryStream.toByteArray()));
}
