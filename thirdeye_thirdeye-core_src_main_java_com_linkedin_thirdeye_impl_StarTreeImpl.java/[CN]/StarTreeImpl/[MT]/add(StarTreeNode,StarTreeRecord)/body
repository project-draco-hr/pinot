{
  if (node.isLeaf()) {
    node.getRecordStore().update(record);
    boolean valid=true;
    if (!node.getDimensionValue().equals(StarTreeConstants.STAR)) {
      for (      String name : node.getAncestorDimensionNames()) {
        String recordValue=record.getDimensionKey().getDimensionValue(config.getDimensions(),name);
        if (!recordValue.equals(node.getAncestorDimensionValues().get(name))) {
          valid=false;
        }
      }
      String recordValue=record.getDimensionKey().getDimensionValue(config.getDimensions(),node.getDimensionName());
      if (!recordValue.equals(node.getDimensionValue())) {
        valid=false;
      }
    }
    if (valid) {
      if (LOGGER.isTraceEnabled()) {
        LOGGER.trace("Added record:{} to node:{}",StarTreeUtils.toDimensionString(record,config.getDimensions()),node.getPath());
      }
    }
 else {
      LOGGER.error("INVALID: Added record:{} to node:{}",StarTreeUtils.toDimensionString(record,config.getDimensions()),node.getPath());
    }
    if (shouldSplit(node)) {
synchronized (node) {
        if (shouldSplit(node)) {
          Set<String> blacklist=new HashSet<String>();
          blacklist.addAll(node.getAncestorDimensionNames());
          blacklist.add(node.getDimensionName());
          String splitDimensionName=null;
          if (config.getSplit().getOrder() == null) {
            splitDimensionName=node.getRecordStore().getMaxCardinalityDimension(blacklist);
          }
 else {
            for (            String dimensionName : config.getSplit().getOrder()) {
              if (!blacklist.contains(dimensionName)) {
                splitDimensionName=dimensionName;
                break;
              }
            }
          }
          if (splitDimensionName != null) {
            node.split(splitDimensionName);
          }
        }
      }
    }
  }
 else {
    String childDimensionName=node.getChildDimensionName();
    String childDimensionValue=record.getDimensionKey().getDimensionValue(config.getDimensions(),childDimensionName);
    StarTreeNode target=node.getChild(childDimensionValue);
    if (target == null) {
      if (config.isFixed()) {
        target=node.getOtherNode();
        StarTreeRecord aliasOtherRecord=record.aliasOther(childDimensionName);
        add(target,aliasOtherRecord);
      }
 else {
        target=node.addChildNode(childDimensionValue);
        add(target,record);
      }
    }
 else {
      add(target,record);
    }
    add(node.getStarNode(),record.relax(childDimensionName));
  }
}
