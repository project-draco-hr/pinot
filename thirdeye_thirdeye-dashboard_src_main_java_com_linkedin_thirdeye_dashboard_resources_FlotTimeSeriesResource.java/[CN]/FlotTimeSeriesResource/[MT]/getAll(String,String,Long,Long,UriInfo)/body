{
  DateTime baseline=new DateTime(baselineMillis);
  DateTime current=new DateTime(currentMillis);
  Map<String,Map<String,List<String>>> reverseDimensionGroups=null;
  DimensionGroupSpec dimensionGroupSpec=configCache.getDimensionGroupSpec(collection);
  if (dimensionGroupSpec != null) {
    reverseDimensionGroups=dimensionGroupSpec.getReverseMapping();
  }
  CollectionSchema schema=dataCache.getCollectionSchema(serverUri,collection);
  String sql=SqlUtils.getSql(metricFunction,collection,baseline,current,uriInfo.getQueryParameters(),reverseDimensionGroups);
  QueryResult queryResult=queryCache.getQueryResult(serverUri,sql).checkEmpty();
  List<FlotTimeSeries> allSeries=FlotTimeSeries.fromQueryResult(schema,objectMapper,queryResult);
  if (displayAnomalies) {
    List<AnomalyTableRow> anomalies=AnomalyTable.selectRows(anomalyDatabase,collection,null,null,null,null,null,false,null,new TimeRange(baselineMillis,currentMillis));
    allSeries.addAll(FlotTimeSeries.anomaliesFromQueryResult(schema,objectMapper,queryResult,ANOMALY_LABEL_PREFIX,anomalies));
  }
  return allSeries;
}
