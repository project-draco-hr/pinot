{
  FunnelSpec spec=funnelSpecsMap.get(collection).getFunnels().get(funnel);
  DateTime currentEnd=new DateTime(currentMillis);
  DateTime currentStart=currentEnd.minusDays(1);
  DateTime baselineEnd=new DateTime(baselineMillis);
  DateTime baselineStart=baselineEnd.minusDays(1);
  String metricFunction="AGGREGATE_1_HOURS(" + METRIC_FUNCTION_JOINER.join(spec.getActualMetricNames()) + ")";
  DimensionGroupSpec dimSpec=DimensionGroupSpec.emptySpec(collection);
  Map<String,Map<String,List<String>>> dimensionGroups=DimensionGroupSpec.emptySpec(collection).getReverseMapping();
  String baselineSql=SqlUtils.getSql(metricFunction,collection,baselineStart,baselineEnd,dimensionValuesMap,dimensionGroups);
  String currentSql=SqlUtils.getSql(metricFunction,collection,currentStart,currentEnd,dimensionValuesMap,dimensionGroups);
  LOG.info("funnel queries for collection : {}, with name : {} ",collection,spec.getName());
  LOG.info("Generated SQL: {}",baselineSql);
  LOG.info("Generated SQL: {}",currentSql);
  Future<QueryResult> baselineResult=queryCache.getQueryResultAsync(serverUri,baselineSql);
  Future<QueryResult> currentResult=queryCache.getQueryResultAsync(serverUri,currentSql);
  Map<Long,Number[]> baselineData=CustomDashboardResource.extractFunnelData(baselineResult.get());
  Map<Long,Number[]> currentData=CustomDashboardResource.extractFunnelData(currentResult.get());
  long baselineOffsetMillis=currentEnd.getMillis() - baselineEnd.getMillis();
  long intraPeriod=currentEnd.getMillis() - currentStart.getMillis();
  List<MetricDataRow> table=ViewUtils.extractMetricDataRows(baselineData,currentData,currentEnd.getMillis(),baselineOffsetMillis,intraPeriod);
  Map<String,Integer> metricNameToIndex=new HashMap<>();
  List<String> resultMetrics=baselineResult.get().getMetrics();
  for (int i=0; i < resultMetrics.size(); i++) {
    metricNameToIndex.put(resultMetrics.get(i),i);
  }
  List<MetricDataRow> filteredTable=new ArrayList<>();
  int metricCount=spec.getActualMetricNames().size();
  List<MetricDataRow> filteredCumulativeTable=new ArrayList<>();
  Number[] cumulativeBaseline=new Number[metricCount];
  Arrays.fill(cumulativeBaseline,0.0);
  Number[] cumulativeCurrent=new Number[metricCount];
  Arrays.fill(cumulativeCurrent,0.0);
  for (  MetricDataRow row : table) {
    Number[] filteredBaseline=new Number[metricCount];
    Number[] filteredCurrent=new Number[metricCount];
    for (int i=0; i < metricCount; i++) {
      String metricName=spec.getActualMetricNames().get(i);
      Integer metricIdx=metricNameToIndex.get(metricName);
      Number baselineValue=null;
      if (row.getBaseline() != null) {
        try {
          baselineValue=row.getBaseline()[metricIdx];
        }
 catch (        Exception e) {
          LOG.error("",e);
        }
      }
      filteredBaseline[i]=baselineValue;
      Number currentValue=null;
      if (row.getCurrent() != null) {
        try {
          currentValue=row.getCurrent()[metricIdx];
        }
 catch (        Exception e) {
          LOG.error("",e);
        }
      }
      filteredCurrent[i]=currentValue;
      cumulativeBaseline[i]=cumulativeBaseline[i].doubleValue() + (baselineValue == null ? 0.0 : baselineValue.doubleValue());
      cumulativeCurrent[i]=cumulativeCurrent[i].doubleValue() + (currentValue == null ? 0.0 : currentValue.doubleValue());
    }
    MetricDataRow filteredRow=new MetricDataRow(row.getBaselineTime(),filteredBaseline,row.getCurrentTime(),filteredCurrent);
    filteredTable.add(filteredRow);
    Number[] cumulativeBaselineCopy=Arrays.copyOf(cumulativeBaseline,cumulativeBaseline.length);
    Number[] cumulativeCurrentCopy=Arrays.copyOf(cumulativeCurrent,cumulativeCurrent.length);
    MetricDataRow cumulativeFilteredRow=new MetricDataRow(row.getBaselineTime(),cumulativeBaselineCopy,row.getCurrentTime(),cumulativeCurrentCopy);
    filteredCumulativeTable.add(cumulativeFilteredRow);
  }
  return new FunnelHeatMapView(spec,filteredTable,filteredCumulativeTable,currentEnd,baselineEnd);
}
