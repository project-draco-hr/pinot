{
  List<LiveInstance> liveInstances=changeContext.getManager().getHelixDataAccessor().getChildValues(new PropertyKey.Builder(clusterName).liveInstances());
  for (  LiveInstance instance : liveInstances) {
    String instanceId=instance.getId();
    String sessionId=instance.getSessionId();
    if (instanceId.indexOf(CommonConstants.Helix.PREFIX_OF_SERVER_INSTANCE) != -1) {
      continue;
    }
    String namePortStr=instanceId.split(CommonConstants.Helix.PREFIX_OF_SERVER_INSTANCE)[1];
    String hostName=namePortStr.split(ServerToSegmentSetMap.NAME_PORT_DELIMITER)[0];
    int port;
    try {
      port=Integer.parseInt(namePortStr.split(ServerToSegmentSetMap.NAME_PORT_DELIMITER)[1]);
    }
 catch (    Exception e) {
      port=CommonConstants.Helix.DEFAULT_SERVER_NETTY_PORT;
    }
    ServerInstance ins=new ServerInstance(hostName,port);
    if (liveInstanceToSessionIdMap.containsKey(instanceId)) {
      if (!sessionId.equals(liveInstanceToSessionIdMap.get(instanceId))) {
        try {
          KeyedFuture<ServerInstance,NettyClientConnection> c=connectionPool.checkoutObject(ins);
          for (          Map.Entry<ServerInstance,NettyClientConnection> entry : c.get().entrySet()) {
            if (!entry.getValue().validate()) {
              connectionPool.destroyObject(ins,entry.getValue());
            }
          }
          liveInstanceToSessionIdMap.put(instanceId,sessionId);
        }
 catch (        Exception e) {
          LOGGER.error("error trying to destroy dead connections : {} ",e);
        }
      }
    }
 else {
      try {
        KeyedFuture<ServerInstance,NettyClientConnection> c=connectionPool.checkoutObject(ins);
        NettyClientConnection conn=c.getOne(timeout,TimeUnit.MILLISECONDS);
        if (conn != null) {
          if (!conn.validate()) {
            for (            Map.Entry<ServerInstance,NettyClientConnection> entry : c.get().entrySet()) {
              if (!entry.getValue().validate()) {
                connectionPool.destroyObject(ins,entry.getValue());
              }
            }
          }
          liveInstanceToSessionIdMap.put(instanceId,sessionId);
        }
      }
 catch (      Exception e) {
        LOGGER.error("error trying to destroy dead connections : {}",e);
      }
    }
  }
}
