{
  this._helixPropertyStore=propertyStore;
  String segmentId=segmentZKMetadata.getSegmentName();
  if (segmentZKMetadata instanceof RealtimeSegmentZKMetadata) {
    if (new File(_indexDir,segmentId).exists() && ((RealtimeSegmentZKMetadata)segmentZKMetadata).getStatus() == Status.DONE) {
      if (!_segmentsMap.containsKey(segmentId)) {
synchronized (getGlobalLock()) {
          if (!_segmentsMap.containsKey(segmentId)) {
            IndexSegment segment=ColumnarSegmentLoader.load(new File(_indexDir,segmentId),_readMode,_indexLoadingConfigMetadata);
            _segmentsMap.put(segmentId,new OfflineSegmentDataManager(segment));
            markSegmentAsLoaded(segmentId);
            _referenceCounts.put(segmentId,new AtomicInteger(1));
          }
        }
      }
    }
 else {
      if (!_segmentsMap.containsKey(segmentId)) {
synchronized (getGlobalLock()) {
          if (!_segmentsMap.containsKey(segmentId)) {
            SegmentDataManager manager=new RealtimeSegmentDataManager((RealtimeSegmentZKMetadata)segmentZKMetadata,(RealtimeDataResourceZKMetadata)dataResourceZKMetadata,instanceZKMetadata,this,_indexDir.getAbsolutePath(),_readMode);
            _logger.info("Initialize RealtimeSegmentDataManager - " + segmentId);
            _segmentsMap.put(segmentId,manager);
            _loadingSegments.add(segmentId);
            _referenceCounts.put(segmentId,new AtomicInteger(1));
          }
        }
      }
    }
  }
}
