{
  PinotResourceManagerResponse res;
  IdealState idealState;
  Assert.assertEquals(_helixAdmin.getInstancesInClusterWithTag(HELIX_CLUSTER_NAME,"broker_colocated").size(),6);
  Assert.assertEquals(_helixAdmin.getInstancesInClusterWithTag(HELIX_CLUSTER_NAME,"broker_untagged").size(),0);
  idealState=_helixAdmin.getResourceIdealState(HELIX_CLUSTER_NAME,CommonConstants.Helix.BROKER_RESOURCE_INSTANCE);
  Assert.assertEquals(idealState.getInstanceSet("company").size(),6);
  Thread.sleep(3000);
  final HelixBrokerStarter helixBrokerStarter=_helixBrokerStarters.get(0);
  HelixExternalViewBasedRouting helixExternalViewBasedRouting=helixBrokerStarter.getHelixExternalViewBasedRouting();
  Assert.assertEquals(Arrays.toString(helixExternalViewBasedRouting.getDataResourceSet().toArray()),"[company]");
  res=_pinotResourceManager.createBrokerDataResource(createBrokerDataResourceConfig("cap",6,"broker_colocated"));
  Assert.assertEquals(res.status == STATUS.success,true);
  Assert.assertEquals(_helixAdmin.getInstancesInClusterWithTag(HELIX_CLUSTER_NAME,"broker_colocated").size(),6);
  Assert.assertEquals(_helixAdmin.getInstancesInClusterWithTag(HELIX_CLUSTER_NAME,"broker_untagged").size(),0);
  idealState=_helixAdmin.getResourceIdealState(HELIX_CLUSTER_NAME,CommonConstants.Helix.BROKER_RESOURCE_INSTANCE);
  Assert.assertEquals(idealState.getInstanceSet("cap").size(),6);
  Assert.assertEquals(idealState.getInstanceSet("company").size(),6);
  Thread.sleep(3000);
  helixExternalViewBasedRouting=helixBrokerStarter.getHelixExternalViewBasedRouting();
  Assert.assertEquals(Arrays.toString(helixExternalViewBasedRouting.getDataResourceSet().toArray()),"[cap, company]");
  Set<String> serverSet=helixExternalViewBasedRouting.getBrokerRoutingTable().get("company").get(0).getServerSet();
  Assert.assertEquals(helixExternalViewBasedRouting.getBrokerRoutingTable().get("company").get(0).getSegmentSet(serverSet.iterator().next()).size(),5);
  final String dataResource="company";
  addOneSegment(dataResource);
  Thread.sleep(2000);
  helixExternalViewBasedRouting=helixBrokerStarter.getHelixExternalViewBasedRouting();
  Assert.assertEquals(Arrays.toString(helixExternalViewBasedRouting.getDataResourceSet().toArray()),"[cap, company]");
  serverSet=helixExternalViewBasedRouting.getBrokerRoutingTable().get("company").get(0).getServerSet();
  Assert.assertEquals(helixExternalViewBasedRouting.getBrokerRoutingTable().get("company").get(0).getSegmentSet(serverSet.iterator().next()).size(),6);
}
