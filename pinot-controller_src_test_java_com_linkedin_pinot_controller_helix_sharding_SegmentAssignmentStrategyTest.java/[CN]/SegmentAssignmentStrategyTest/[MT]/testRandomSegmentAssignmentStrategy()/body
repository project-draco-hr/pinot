{
  final int numRelicas=2;
  final int numInstancesPerReplica=10;
  final int totalNumInstances=numRelicas * numInstancesPerReplica;
  String resourceName="testResource";
  String brokerTag="broker_testResource";
  JSONObject payload=ControllerRequestBuilderUtil.buildBrokerTenantCreateRequestJSON(brokerTag,5);
  ControllerTest.sendPostRequest(ControllerRequestURLBuilder.baseUrl(CONTROLLER_BASE_API_URL).forTenantCreate(),payload.toString());
  String serverTag="serverTag_0";
  Tenant serverTenant=new Tenant(TenantRole.SERVER,serverTag,6,3,3);
  _pinotResourceManager.createServerTenant(serverTenant);
  final DataResource resource=ControllerRequestBuilderUtil.createOfflineClusterCreationConfig(serverTag,brokerTag,numRelicas,RESOURCE_NAME_RANDOM,"RandomAssignmentStrategy");
  _pinotResourceManager.handleCreateNewDataResource(resource);
  Thread.sleep(3000);
  for (int i=0; i < 10; ++i) {
    addOneSegment(RESOURCE_NAME_RANDOM);
    Thread.sleep(2000);
    final List<String> taggedInstances=_helixAdmin.getInstancesInClusterWithTag(HELIX_CLUSTER_NAME,BrokerRequestUtils.getOfflineResourceNameForResource(RESOURCE_NAME_RANDOM));
    final Map<String,Integer> instance2NumSegmentsMap=new HashMap<String,Integer>();
    for (    final String instance : taggedInstances) {
      instance2NumSegmentsMap.put(instance,0);
    }
    final ExternalView externalView=_helixAdmin.getResourceExternalView(HELIX_CLUSTER_NAME,BrokerRequestUtils.getOfflineResourceNameForResource(RESOURCE_NAME_RANDOM));
    Assert.assertEquals(externalView.getPartitionSet().size(),i + 1);
    for (    final String segmentId : externalView.getPartitionSet()) {
      Assert.assertEquals(externalView.getStateMap(segmentId).size(),numRelicas);
    }
  }
}
