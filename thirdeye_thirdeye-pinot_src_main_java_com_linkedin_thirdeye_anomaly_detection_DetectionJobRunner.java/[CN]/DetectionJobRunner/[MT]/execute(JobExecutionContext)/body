{
  LOG.info("Running " + jobExecutionContext.getJobDetail().getKey().toString());
  jobContext=(JobContext)jobExecutionContext.getJobDetail().getJobDataMap().get(DETECTION_JOB_CONTEXT);
  sessionFactory=jobContext.getSessionFactory();
  anomalyJobSpecDAO=jobContext.getAnomalyJobSpecDAO();
  anomalyTasksSpecDAO=jobContext.getAnomalyTaskSpecDAO();
  anomalyFunctionSpecDAO=jobContext.getAnomalyFunctionSpecDAO();
  anomalyFunctionId=jobContext.getAnomalyFunctionId();
  jobName=jobContext.getJobName();
  AnomalyFunctionSpec anomalyFunctionSpec=getAnomalyFunctionSpec(anomalyFunctionId);
  String windowEndProp=jobContext.getWindowEndIso();
  String windowStartProp=jobContext.getWindowStartIso();
  if (windowEndProp == null) {
    long delayMillis=0;
    if (anomalyFunctionSpec.getWindowDelay() != null) {
      delayMillis=TimeUnit.MILLISECONDS.convert(anomalyFunctionSpec.getWindowDelay(),anomalyFunctionSpec.getWindowDelayUnit());
    }
    Date scheduledFireTime=jobExecutionContext.getScheduledFireTime();
    windowEnd=new DateTime(scheduledFireTime).minus(delayMillis);
  }
 else {
    windowEnd=ISODateTimeFormat.dateTimeParser().parseDateTime(windowEndProp);
  }
  if (windowStartProp == null) {
    int windowSize=anomalyFunctionSpec.getWindowSize();
    TimeUnit windowUnit=anomalyFunctionSpec.getWindowUnit();
    long windowMillis=TimeUnit.MILLISECONDS.convert(windowSize,windowUnit);
    windowStart=windowEnd.minus(windowMillis);
  }
 else {
    windowStart=ISODateTimeFormat.dateTimeParser().parseDateTime(windowStartProp);
  }
  jobContext.setWindowStart(windowStart);
  jobContext.setWindowEnd(windowEnd);
  Long jobExecutionId=createAnomalyJob(jobName);
  jobContext.setJobExecutionId(jobExecutionId);
  List<Long> taskIds=createAnomalyTasks(anomalyFunctionSpec);
}
