{
  long start=System.currentTimeMillis();
  final ImmutableRoaringBitmap[] bitMapArray=new ImmutableRoaringBitmap[blocks.length];
  for (int i=0; i < blocks.length; i++) {
    bitMapArray[i]=(ImmutableRoaringBitmap)blocks[i].getBlockDocIdSet().getRaw();
  }
  MutableRoaringBitmap answer;
  if (blocks.length == 1) {
    answer=new MutableRoaringBitmap();
    answer.or(bitMapArray[0]);
  }
 else   if (blocks.length == 2) {
    answer=ImmutableRoaringBitmap.or(bitMapArray[0],bitMapArray[1]);
  }
 else {
    PriorityQueue<ImmutableRoaringBitmap> pq=new PriorityQueue<ImmutableRoaringBitmap>(blocks.length,new Comparator<ImmutableRoaringBitmap>(){
      @Override public int compare(      ImmutableRoaringBitmap a,      ImmutableRoaringBitmap b){
        return a.getSizeInBytes() - b.getSizeInBytes();
      }
    }
);
    for (int srcId=0; srcId < blocks.length; srcId++) {
      pq.add(bitMapArray[srcId]);
    }
    ImmutableRoaringBitmap x1=pq.poll();
    ImmutableRoaringBitmap x2=pq.poll();
    answer=ImmutableRoaringBitmap.or(x1,x2);
    while (pq.size() > 0) {
      answer.or(pq.poll());
    }
  }
  boolean validate=false;
  if (validate) {
    final MutableRoaringBitmap bit=((ImmutableRoaringBitmap)blocks[0].getBlockDocIdSet().getRaw()).toMutableRoaringBitmap();
    for (int srcId=1; srcId < blocks.length; srcId++) {
      final MutableRoaringBitmap bitToAndWith=((ImmutableRoaringBitmap)blocks[srcId].getBlockDocIdSet().getRaw()).toMutableRoaringBitmap();
      bit.or(bitToAndWith);
    }
    if (!answer.equals(bit)) {
      LOGGER.error("Optimized result differs from unoptimized solution, \n\t optimized: " + answer + " \n\t unoptimized: "+ bit);
    }
  }
  long end=System.currentTimeMillis();
  LOGGER.info("And operator took: " + (end - start));
  return new IntBlockDocIdSet(answer);
}
