{
  StarTree starTree=starTreeManager.getStarTree(collection);
  if (starTree == null) {
    throw new NotFoundException("No collection " + collection);
  }
  TimeRange timeRange=movingAverageWindow != null ? new TimeRange(baselineStart - movingAverageWindow,currentEnd) : new TimeRange(baselineStart,currentEnd);
  Map<String,MetricTimeSeries> timeSeriesByDimensionValue=doQuery(starTree,dimensionName,timeRange,uriInfo);
  if (movingAverageWindow != null) {
    for (    Map.Entry<String,MetricTimeSeries> entry : timeSeriesByDimensionValue.entrySet()) {
      timeSeriesByDimensionValue.put(entry.getKey(),MetricTimeSeriesUtils.getSimpleMovingAverage(entry.getValue(),baselineStart,currentEnd,movingAverageWindow));
    }
  }
  return heatMap.generateHeatMap(metricName,timeSeriesByDimensionValue,new TimeRange(baselineStart,baselineEnd),new TimeRange(currentStart,currentEnd));
}
