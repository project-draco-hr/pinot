{
synchronized (sync) {
    List<StarTreeRecord> list=new LinkedList<StarTreeRecord>();
    buffer.clear();
    int[] currentDimensions=new int[dimensionSpecs.size()];
    Number[] currentMetrics=new Number[metricSpecs.size()];
    while (buffer.position() < buffer.limit()) {
      getDimensions(currentDimensions);
      Map<String,String> values=translateDimensions(currentDimensions);
      for (int i=0; i < numTimeBuckets; i++) {
        long time=getMetrics(currentMetrics);
        StarTreeRecordImpl.Builder builder=new StarTreeRecordImpl.Builder();
        builder.setDimensionValues(values).setTime(time);
        for (int j=0; j < metricSpecs.size(); j++) {
          builder.setMetricValue(metricSpecs.get(j).getName(),currentMetrics[j]);
          builder.setMetricType(metricSpecs.get(j).getName(),metricSpecs.get(j).getType());
        }
        list.add(builder.build());
      }
    }
    return list.iterator();
  }
}
