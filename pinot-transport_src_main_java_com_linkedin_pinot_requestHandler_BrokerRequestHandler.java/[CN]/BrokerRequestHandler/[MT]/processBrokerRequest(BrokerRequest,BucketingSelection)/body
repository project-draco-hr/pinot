{
  if (request == null || request.getQuerySource() == null || request.getQuerySource().getResourceName() == null) {
    LOGGER.info("Query contains null resource.");
    return BrokerResponse.getNullBrokerResponse();
  }
  RoutingTableLookupRequest rtRequest=new RoutingTableLookupRequest(request.getQuerySource().getResourceName());
  Map<ServerInstance,SegmentIdSet> segmentServices=_routingTable.findServers(rtRequest);
  if (segmentServices == null) {
    LOGGER.info("Not found ServerInstances to Segments Mapping:");
    return BrokerResponse.getNullBrokerResponse();
  }
  LOGGER.info("Find ServerInstances to Segments Mapping:");
  for (  ServerInstance serverInstance : segmentServices.keySet()) {
    LOGGER.info(serverInstance + " : " + segmentServices.get(serverInstance));
  }
  ScatterGatherRequestImpl scatterRequest=new ScatterGatherRequestImpl(request,segmentServices,_replicaSelection,ReplicaSelectionGranularity.SEGMENT_ID_SET,request.getBucketHashKey(),0,overriddenSelection,_requestIdGen.incrementAndGet(),10 * 1000L);
  CompositeFuture<ServerInstance,ByteBuf> response=_scatterGatherer.scatterGather(scatterRequest);
  Map<ServerInstance,DataTable> instanceResponseMap=null;
{
    Map<ServerInstance,ByteBuf> responses=null;
    try {
      responses=response.get();
    }
 catch (    ExecutionException e) {
      e.printStackTrace();
    }
    Map<ServerInstance,Throwable> errors=response.getError();
    instanceResponseMap=new HashMap<ServerInstance,DataTable>();
    if (null != responses) {
      for (      Entry<ServerInstance,ByteBuf> e : responses.entrySet()) {
        try {
          ByteBuf b=e.getValue();
          byte[] b2=new byte[b.readableBytes()];
          if (b2 == null || b2.length == 0) {
            continue;
          }
          b.readBytes(b2);
          DataTable r2=new DataTable(b2);
          instanceResponseMap.put(e.getKey(),r2);
        }
 catch (        Exception ex) {
          LOGGER.error("Got exceptions in collect query result for instance " + e.getKey() + ", error: "+ ex.getMessage());
        }
      }
    }
    if (null != errors) {
      for (      Entry<ServerInstance,Throwable> e : errors.entrySet()) {
        DataTable r2=new DataTable();
        r2.getMetadata().put("exception",new RequestProcessingException(e.getValue()).toString());
        instanceResponseMap.put(e.getKey(),r2);
      }
    }
  }
  return _reduceService.reduceOnDataTable(request,instanceResponseMap);
}
