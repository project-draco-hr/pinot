{
  try {
    resp.setCharacterEncoding("UTF-8");
    BrokerResponse brokerResponse=broker.handleRequest(extractJSON(req));
    String jsonString=brokerResponse.toJsonString();
    resp.getOutputStream().print(jsonString);
    resp.getOutputStream().flush();
    resp.getOutputStream().close();
  }
 catch (  final Exception e) {
    resp.getOutputStream().print(e.getMessage());
    resp.getOutputStream().flush();
    resp.getOutputStream().close();
    LOGGER.error("Caught exception while processing POST request",e);
    brokerMetrics.addMeteredGlobalValue(BrokerMeter.UNCAUGHT_POST_EXCEPTIONS,1);
  }
}
