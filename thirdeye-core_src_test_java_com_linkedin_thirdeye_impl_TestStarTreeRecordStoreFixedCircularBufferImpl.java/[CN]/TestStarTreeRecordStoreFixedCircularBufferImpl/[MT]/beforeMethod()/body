{
  rootDir=new File(System.getProperty("java.io.tmpdir"),TestStarTreeRecordStoreFixedCircularBufferImpl.class.getSimpleName());
  FileUtils.forceMkdir(rootDir);
  UUID nodeId=UUID.randomUUID();
  bufferFile=new File(rootDir,nodeId.toString() + StarTreeRecordStoreFactoryFixedCircularBufferImpl.BUFFER_SUFFIX);
  int valueId=StarTreeConstants.FIRST_VALUE;
  for (  String dimensionName : dimensionNames) {
    Map<String,Integer> valueIds=new HashMap<String,Integer>();
    for (int i=0; i < 1000; i++) {
      valueIds.put(dimensionName + i,valueId++);
    }
    valueIds.put(StarTreeConstants.STAR,StarTreeConstants.STAR_VALUE);
    valueIds.put(StarTreeConstants.OTHER,StarTreeConstants.OTHER_VALUE);
    forwardIndex.put(dimensionName,valueIds);
  }
  int numEntries=1000;
  int entrySize=StarTreeRecordStoreFixedCircularBufferImpl.getEntrySize(dimensionNames,metricNames);
  FileChannel fileChannel=new RandomAccessFile(bufferFile,"rw").getChannel();
  MappedByteBuffer buffer=fileChannel.map(FileChannel.MapMode.READ_WRITE,0,(numEntries + 4) * entrySize);
  StarTreeRecord otherRecord=new StarTreeRecordImpl.Builder().setDimensionValue("A",StarTreeConstants.OTHER).setDimensionValue("B",StarTreeConstants.OTHER).setDimensionValue("C",StarTreeConstants.OTHER).setMetricValue("M",0L).setTime(0L).build();
  StarTreeRecordStoreFixedCircularBufferImpl.writeRecord(buffer,otherRecord,dimensionNames,metricNames,forwardIndex,4);
  long lastTime=0;
  for (int i=0; i < numEntries; i++) {
    long currentTime=(long)i / 250;
    if (lastTime < currentTime) {
      otherRecord=new StarTreeRecordImpl.Builder().setDimensionValue("A",StarTreeConstants.OTHER).setDimensionValue("B",StarTreeConstants.OTHER).setDimensionValue("C",StarTreeConstants.OTHER).setMetricValue("M",0L).setTime(currentTime).build();
      StarTreeRecordStoreFixedCircularBufferImpl.writeRecord(buffer,otherRecord,dimensionNames,metricNames,forwardIndex,4);
    }
    StarTreeRecord record=new StarTreeRecordImpl.Builder().setDimensionValue("A","A" + i % 250).setDimensionValue("B","B" + i % 500).setDimensionValue("C","C" + i).setMetricValue("M",1L).setTime(currentTime).build();
    StarTreeRecordStoreFixedCircularBufferImpl.writeRecord(buffer,record,dimensionNames,metricNames,forwardIndex,4);
    lastTime=currentTime;
  }
  buffer.force();
  File forwardIndexFile=new File(rootDir,nodeId.toString() + StarTreeRecordStoreFactoryFixedCircularBufferImpl.INDEX_SUFFIX);
  OutputStream outputStream=new FileOutputStream(forwardIndexFile);
  new ObjectMapper().writeValue(outputStream,forwardIndex);
  outputStream.flush();
  outputStream.close();
  Properties props=new Properties();
  props.put("rootDir",rootDir.getAbsolutePath());
  StarTreeRecordStoreFactory recordStoreFactory=new StarTreeRecordStoreFactoryFixedCircularBufferImpl();
  recordStoreFactory.init(dimensionNames,metricNames,props);
  recordStore=recordStoreFactory.createRecordStore(nodeId);
  recordStore.open();
}
