{
  SegmentMetadataImpl metadata=new SegmentMetadataImpl(_segmentDir);
  IndexSegmentImpl indexSegment=(IndexSegmentImpl)Loaders.IndexSegment.load(_segmentDir,ReadMode.heap);
  FilterQueryTree filterQueryTree=RequestUtils.generateFilterQueryTree(_brokerRequest);
  List<Integer> filteredDocIds=filterDocIds(indexSegment,metadata,filterQueryTree);
  ResultTable result=null;
  if (_brokerRequest.isSetAggregationsInfo()) {
    if (!_brokerRequest.isSetGroupBy()) {
      Aggregation aggregation=new Aggregation(indexSegment,metadata,filteredDocIds,_brokerRequest.getAggregationsInfo());
      return aggregation.run();
    }
 else {
      AggregationGroupBy aggregationGroupBy=new AggregationGroupBy(indexSegment,metadata,filteredDocIds,_brokerRequest.getAggregationsInfo());
      return aggregationGroupBy.run();
    }
  }
  if (_brokerRequest.isSetSelections()) {
    Selection selection=new Selection(indexSegment,metadata,filteredDocIds,_brokerRequest.getSelections().getSelectionColumns());
    result=selection.run();
  }
  return result;
}
