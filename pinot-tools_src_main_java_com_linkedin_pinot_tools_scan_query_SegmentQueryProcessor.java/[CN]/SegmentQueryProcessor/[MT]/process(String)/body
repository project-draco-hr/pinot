{
  SegmentMetadataImpl metadata=new SegmentMetadataImpl(_segmentDir);
  IndexSegmentImpl indexSegment=(IndexSegmentImpl)Loaders.IndexSegment.load(_segmentDir,ReadMode.heap);
  FilterQueryTree filterQueryTree=RequestUtils.generateFilterQueryTree(_brokerRequest);
  List<Integer> filteredDocIds=filterDocIds(indexSegment,metadata,filterQueryTree);
  ResultTable result=null;
  if (_brokerRequest.isSetAggregationsInfo()) {
    if (!_brokerRequest.isSetGroupBy()) {
      Aggregation aggregation=new Aggregation(indexSegment,metadata,filteredDocIds,_brokerRequest.getAggregationsInfo(),null);
      result=aggregation.run();
    }
 else {
      Aggregation aggregation=new Aggregation(indexSegment,metadata,filteredDocIds,_brokerRequest.getAggregationsInfo(),_brokerRequest.getGroupBy().getColumns());
      result=aggregation.run();
    }
  }
 else {
    if (_brokerRequest.isSetSelections()) {
      Selection selection=new Selection(indexSegment,metadata,filteredDocIds,_brokerRequest.getSelections().getSelectionColumns());
      result=selection.run();
    }
  }
  result.setNumDocsScanned(filteredDocIds.size());
  result.setTotalDocs(metadata.getTotalDocs());
  return result;
}
