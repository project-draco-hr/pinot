{
  for (int i=0; i < dimensionNames.size(); i++) {
    String dimensionName=dimensionNames.get(i);
    String dimensionValue="";
    Object val=record.datum().get(dimensionName);
    if (val != null) {
      dimensionValue=val.toString();
    }
    dimensionValues[i]=dimensionValue;
  }
  StarTreeRecord starTreeRecord=ThirdEyeAvroUtils.convert(starTreeConfig,record.datum());
  MetricTimeSeries originalSeries=starTreeRecord.getMetricTimeSeries();
  MetricTimeSeries flattenedSeries=new MetricTimeSeries(metricSchema);
  for (  Long time : originalSeries.getTimeWindowSet()) {
    for (int i=0; i < metricNames.size(); i++) {
      String name=metricNames.get(i);
      flattenedSeries.increment(-1,name,originalSeries.get(time,name));
    }
  }
  byte[] serializedKey=starTreeRecord.getDimensionKey().toBytes();
  byte[] serializedMetrics=flattenedSeries.toBytes();
  ByteArrayOutputStream baos=new ByteArrayOutputStream();
  baos.write(serializedKey.length);
  baos.write(serializedKey);
  baos.write(serializedMetrics.length);
  baos.write(serializedMetrics);
  context.write(new BytesWritable(serializedKey),new BytesWritable(serializedMetrics));
}
