{
  final String resourceName;
  if (segmentZKMetadata instanceof RealtimeSegmentZKMetadata) {
    resourceName=BrokerRequestUtils.buildRealtimeResourceNameForResource(segmentZKMetadata.getResourceName());
  }
 else {
    resourceName=BrokerRequestUtils.getOfflineResourceNameForResource(segmentZKMetadata.getResourceName());
  }
  final String segmentName=segmentZKMetadata.getSegmentName();
  HelixDataAccessor helixDataAccessor=_helixZkManager.getHelixDataAccessor();
  PropertyKey idealStatePropertyKey=helixDataAccessor.keyBuilder().idealStates(resourceName);
  boolean updateSuccessful;
  do {
    final IdealState idealState=_helixAdmin.getResourceIdealState(_helixClusterName,resourceName);
    final Set<String> instanceSet=idealState.getInstanceSet(segmentName);
    for (    final String instance : instanceSet) {
      idealState.setPartitionState(segmentName,instance,"OFFLINE");
    }
    updateSuccessful=helixDataAccessor.updateProperty(idealStatePropertyKey,idealState);
  }
 while (!updateSuccessful);
  IdealState updatedIdealState=_helixAdmin.getResourceIdealState(_helixClusterName,resourceName);
  Map<String,String> instanceStateMap=updatedIdealState.getInstanceStateMap(segmentName);
  for (  String state : instanceStateMap.values()) {
    if (!"OFFLINE".equals(state)) {
      LOGGER.error("Failed to write OFFLINE ideal state!");
      return false;
    }
  }
  LOGGER.info("Wait until segment - " + segmentName + " to be OFFLINE in ExternalView");
  if (!ifExternalViewChangeReflectedForState(resourceName,segmentName,"OFFLINE",_externalViewOnlineToOfflineTimeout)) {
    LOGGER.error("Cannot get OFFLINE state to be reflected on ExternalView changed for segment: " + segmentName);
    return false;
  }
  do {
    final IdealState idealState=_helixAdmin.getResourceIdealState(_helixClusterName,resourceName);
    final Set<String> instanceSet=idealState.getInstanceSet(segmentName);
    for (    final String instance : instanceSet) {
      idealState.setPartitionState(segmentName,instance,"ONLINE");
    }
    updateSuccessful=helixDataAccessor.updateProperty(idealStatePropertyKey,idealState);
  }
 while (!updateSuccessful);
  updatedIdealState=_helixAdmin.getResourceIdealState(_helixClusterName,resourceName);
  instanceStateMap=updatedIdealState.getInstanceStateMap(segmentName);
  for (  String state : instanceStateMap.values()) {
    if (!"ONLINE".equals(state)) {
      LOGGER.error("Failed to write ONLINE ideal state!");
      return false;
    }
  }
  LOGGER.info("Refresh is done for segment - " + segmentName);
  return true;
}
