{
  final IdealState brokerIdealState=HelixHelper.getBrokerIdealStates(_helixAdmin,_helixClusterName);
  final List<String> dataResourceList=new ArrayList<String>(brokerIdealState.getPartitionSet());
  for (  final String dataResource : dataResourceList) {
    final Set<String> instances=brokerIdealState.getInstanceSet(dataResource);
    brokerIdealState.getPartitionSet().remove(dataResource);
    for (    final String instance : instances) {
      if (!brokerInstancesToUntag.contains(instance)) {
        brokerIdealState.setPartitionState(dataResource,instance,"ONLINE");
      }
    }
  }
  _helixAdmin.setResourceIdealState(_helixClusterName,CommonConstants.Helix.BROKER_RESOURCE_INSTANCE,brokerIdealState);
  for (  final String brokerInstanceToUntag : brokerInstancesToUntag) {
    _helixAdmin.removeInstanceTag(_helixClusterName,brokerInstanceToUntag,brokerTag);
    _helixAdmin.addInstanceTag(_helixClusterName,brokerInstanceToUntag,CommonConstants.Helix.UNTAGGED_BROKER_INSTANCE);
  }
}
