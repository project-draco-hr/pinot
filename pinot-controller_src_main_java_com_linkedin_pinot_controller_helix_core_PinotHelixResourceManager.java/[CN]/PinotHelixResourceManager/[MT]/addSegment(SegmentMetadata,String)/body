{
  final PinotResourceManagerResponse res=new PinotResourceManagerResponse();
  try {
    if (!matchResourceAndTableName(segmentMetadata)) {
      res.status=STATUS.failure;
      res.errorMessage="Reject segment: resource name and table name are not registered." + " Resource name: " + segmentMetadata.getResourceName() + ", Table name: "+ segmentMetadata.getTableName()+ "\n";
      return res;
    }
    if (ifSegmentExisted(segmentMetadata)) {
      if (ifRefreshAnExistedSegment(segmentMetadata)) {
        final ZNRecord record=new ZNRecord(segmentMetadata.getName());
        record.setSimpleFields(segmentMetadata.toMap());
        record.setSimpleField(V1Constants.SEGMENT_DOWNLOAD_URL,downloadUrl);
        _propertyStore.create(PinotHelixUtils.constructPropertyStorePathForSegment(segmentMetadata),record,AccessOption.PERSISTENT);
        LOGGER.info("Refresh segment : " + segmentMetadata.getName() + " to Property store");
        final IdealState idealState=PinotResourceIdealStateBuilder.updateExistedSegmentToIdealStateFor(segmentMetadata,_helixAdmin,_helixClusterName);
        _helixAdmin.setResourceIdealState(_helixClusterName,segmentMetadata.getResourceName(),idealState);
        LOGGER.info("Refresh segment : " + segmentMetadata.getName() + " in idealStatus");
        res.status=STATUS.success;
      }
    }
 else {
      final ZNRecord record=new ZNRecord(segmentMetadata.getName());
      record.setSimpleFields(segmentMetadata.toMap());
      record.setSimpleField(V1Constants.SEGMENT_DOWNLOAD_URL,downloadUrl);
      _propertyStore.create(PinotHelixUtils.constructPropertyStorePathForSegment(segmentMetadata),record,AccessOption.PERSISTENT);
      LOGGER.info("Added segment : " + segmentMetadata.getName() + " to Property store");
      final IdealState idealState=PinotResourceIdealStateBuilder.addNewSegmentToIdealStateFor(segmentMetadata,_helixAdmin,_helixClusterName);
      _helixAdmin.setResourceIdealState(_helixClusterName,segmentMetadata.getResourceName(),idealState);
      res.status=STATUS.success;
    }
  }
 catch (  final Exception e) {
    res.status=STATUS.failure;
    res.errorMessage=e.getMessage();
    e.printStackTrace();
  }
  return res;
}
