{
  LOGGER.info("START: serializing star tree and the leaf record dimension store");
  String localOutputDir="./staging";
  LinkedList<StarTreeNode> leafNodes=new LinkedList<StarTreeNode>();
  starTree.close();
  StarTreeUtils.traverseAndGetLeafNodes(leafNodes,starTree.getRoot());
  int prevLeafNodes;
  do {
    prevLeafNodes=leafNodes.size();
    LOGGER.info("Number of leaf Nodes" + prevLeafNodes);
    for (    StarTreeNode node : leafNodes) {
      String[] values=new String[starTreeConfig.getDimensions().size()];
      for (int i=0; i < starTreeConfig.getDimensions().size(); i++) {
        String dimensionName=starTreeConfig.getDimensions().get(i).getName();
        if (node.getAncestorDimensionValues().containsKey(dimensionName)) {
          values[i]=node.getAncestorDimensionValues().get(dimensionName);
        }
 else         if (node.getDimensionName().equals(dimensionName)) {
          values[i]=node.getDimensionValue();
        }
 else {
          values[i]=StarTreeConstants.OTHER;
        }
      }
      StarTreeRecord record=new StarTreeRecordImpl(starTreeConfig,new DimensionKey(values),emptyTimeSeries);
      starTree.add(record);
    }
    leafNodes.clear();
    StarTreeUtils.traverseAndGetLeafNodes(leafNodes,starTree.getRoot());
    LOGGER.info("Number of leaf Nodes" + prevLeafNodes);
  }
 while (prevLeafNodes != leafNodes.size());
  starTree.close();
  FileSystem dfs=FileSystem.get(context.getConfiguration());
  Path src, dst;
  StarTreePersistanceUtil.saveTree(starTree,localOutputDir);
  String treeOutputFileName=collectionName + "-tree.bin";
  src=FileSystem.getLocal(new Configuration()).makeQualified(new Path(localOutputDir + "/" + treeOutputFileName));
  dst=dfs.makeQualified(new Path(hdfsOutputPath,"tree.bin"));
  LOGGER.info("Copying " + src + " to "+ dst);
  dfs.copyFromLocalFile(src,dst);
  String dimensionStoreOutputDir=localOutputDir + "/" + "dimensionStore";
  new File(dimensionStoreOutputDir).mkdirs();
  StarTreePersistanceUtil.saveLeafDimensionData(starTree,dimensionStoreOutputDir);
  LOGGER.info("END: serializing the leaf record dimension store");
  String dimensionStoreTarGz=localOutputDir + "/dimensionStore.tar.gz";
  LOGGER.info("Generating " + dimensionStoreTarGz + " from "+ dimensionStoreOutputDir);
  TarGzCompressionUtils.createTarGzOfDirectory(dimensionStoreOutputDir,dimensionStoreTarGz);
  src=FileSystem.getLocal(new Configuration()).makeQualified(new Path(dimensionStoreTarGz));
  dst=dfs.makeQualified(new Path(hdfsOutputPath,"dimensionStore.tar.gz"));
  LOGGER.info("Copying " + src + " to "+ dst);
  dfs.copyFromLocalFile(src,dst);
  File f=new File(localOutputDir);
  FileUtils.deleteDirectory(f);
  f=new File(dimensionStoreTarGz);
  f.delete();
}
