{
  long totBelowReplicationThreshold=0;
  LOGGER.info("Got an external view change, size of list {} ",externalViewList.size());
  for (  ExternalView externalView : externalViewList) {
    long numBelowReplicationThreshold=0;
    if (externalView.getId().equalsIgnoreCase(CommonConstants.Helix.BROKER_RESOURCE_INSTANCE)) {
      continue;
    }
    String tableName=externalView.getResourceName();
    LOGGER.debug("Got external view change for table {}",tableName);
    for (    String partitionName : externalView.getPartitionSet()) {
      long nReplicas=0;
      LOGGER.debug("State for partition {} is {}",partitionName,externalView.getStateMap(partitionName));
      for (      Map.Entry<String,String> serverAndState : externalView.getStateMap(partitionName).entrySet()) {
        if (serverAndState.getValue().equals("ONLINE")) {
          nReplicas++;
        }
      }
      if (nReplicas < 1) {
        numBelowReplicationThreshold++;
      }
    }
    _controllerMetrics.setValueOfTableGauge(externalView.getId(),ControllerGauge.NUM_BELOW_REPLICATION_THRESHOLD,numBelowReplicationThreshold);
    totBelowReplicationThreshold+=numBelowReplicationThreshold;
  }
  LOGGER.info("Got an external view change, size of list {}, {} segments below replication threshold ",externalViewList.size(),totBelowReplicationThreshold);
}
