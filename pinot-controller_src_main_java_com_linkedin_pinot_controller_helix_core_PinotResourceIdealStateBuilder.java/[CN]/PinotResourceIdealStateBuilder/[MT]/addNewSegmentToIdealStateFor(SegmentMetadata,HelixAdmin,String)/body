{
  final String resourceName=segmentMetadata.getResourceName();
  final String segmentName=segmentMetadata.getName();
  if (!SEGMENT_ASSIGNMENT_STRATEGY_MAP.containsKey(resourceName)) {
    Map<String,String> resourceConfig=HelixHelper.getResourceConfigsFor(helixClusterName,resourceName,helixAdmin);
    if ((resourceConfig != null) && resourceConfig.containsKey(CommonConstants.Helix.KEY_OF_SEGMENT_ASSIGNMENT_STRATEGY)) {
      SEGMENT_ASSIGNMENT_STRATEGY_MAP.put(resourceName,SegmentAssignmentStrategyFactory.getSegmentAssignmentStrategy(resourceConfig.get(CommonConstants.Helix.KEY_OF_SEGMENT_ASSIGNMENT_STRATEGY)));
    }
 else {
      SEGMENT_ASSIGNMENT_STRATEGY_MAP.put(resourceName,SegmentAssignmentStrategyFactory.getSegmentAssignmentStrategy(CommonConstants.Helix.DEFAULT_SEGMENT_ASSIGNMENT_STRATEGY));
    }
  }
  final SegmentAssignmentStrategy segmentAssignmentStrategy=SEGMENT_ASSIGNMENT_STRATEGY_MAP.get(resourceName);
  final IdealState currentIdealState=helixAdmin.getResourceIdealState(helixClusterName,resourceName);
  final Set<String> currentInstanceSet=currentIdealState.getInstanceSet(segmentName);
  if (currentInstanceSet.isEmpty()) {
    final int replicas=Integer.parseInt(HelixHelper.getResourceConfigsFor(helixClusterName,resourceName,helixAdmin).get(CommonConstants.Helix.DataSource.NUMBER_OF_COPIES));
    final List<String> selectedInstances=segmentAssignmentStrategy.getAssignedInstances(helixAdmin,helixClusterName,segmentMetadata,replicas);
    for (    final String instance : selectedInstances) {
      currentIdealState.setPartitionState(segmentName,instance,ONLINE);
    }
    currentIdealState.setNumPartitions(currentIdealState.getNumPartitions() + 1);
  }
 else {
    for (    final String instance : currentInstanceSet) {
      currentIdealState.setPartitionState(segmentName,instance,OFFLINE);
      currentIdealState.setPartitionState(segmentName,instance,ONLINE);
    }
  }
  return currentIdealState;
}
