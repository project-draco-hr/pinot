{
  final String pqlString=getQuery().getValues("pql");
  logger.info("*** found pql : " + pqlString);
  JSONObject compiledJSON;
  try {
    compiledJSON=compiler.compile(pqlString);
  }
 catch (  final RecognitionException e) {
    logger.error("Caught exception while processing get request",e);
    return new StringRepresentation(QueryException.PQL_PARSING_ERROR.toString());
  }
  if (!compiledJSON.has("collection")) {
    return new StringRepresentation("your request does not contain the collection information");
  }
  String resource;
  try {
    final String collection=compiledJSON.getString("collection");
    resource=collection.substring(0,collection.indexOf("."));
  }
 catch (  final JSONException e) {
    logger.error("Caught exception while processing get request",e);
    return new StringRepresentation(QueryException.BROKER_RESOURCE_MISSING_ERROR.toString());
  }
  String instanceId=null;
  try {
    List<String> instanceIds=manager.getBrokerInstancesFor(resource);
    if (instanceIds != null || instanceIds.size() > 0) {
      Collections.shuffle(instanceIds);
      instanceId=instanceIds.get(0);
    }
  }
 catch (  final Exception e) {
    logger.error("Caught exception while processing get request",e);
    return new StringRepresentation(QueryException.BROKER_INSTANCE_MISSING_ERROR.toString());
  }
  if (instanceId == null) {
    return new StringRepresentation(QueryException.BROKER_INSTANCE_MISSING_ERROR.toString());
  }
  final String[] splStrings=instanceId.split("_");
  final String host="http://" + splStrings[1];
  final String port=splStrings[2];
  final String resp=sendPQLRaw(host + ":" + port+ "/query",pqlString);
  return new StringRepresentation(resp);
}
