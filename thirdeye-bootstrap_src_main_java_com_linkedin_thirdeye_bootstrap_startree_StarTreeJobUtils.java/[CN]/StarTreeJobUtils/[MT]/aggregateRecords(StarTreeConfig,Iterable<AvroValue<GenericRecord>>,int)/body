{
  Map<String,Map<Long,StarTreeRecord>> records=new HashMap<String,Map<Long,StarTreeRecord>>();
  for (  AvroValue<GenericRecord> avroRecord : avroRecords) {
    StarTreeRecord record=StarTreeUtils.toStarTreeRecord(config,avroRecord.datum());
    Map<Long,StarTreeRecord> timeBuckets=records.get(record.getKey(false));
    if (timeBuckets == null) {
      timeBuckets=new HashMap<Long,StarTreeRecord>();
      records.put(record.getKey(false),timeBuckets);
    }
    long bucket=record.getTime() % numTimeBuckets;
    StarTreeRecord aggRecord=timeBuckets.get(bucket);
    if (aggRecord == null || aggRecord.getTime() < record.getTime()) {
      timeBuckets.put(bucket,record);
    }
 else     if (aggRecord.getTime().equals(record.getTime())) {
      timeBuckets.put(bucket,StarTreeUtils.merge(Arrays.asList(record,aggRecord)));
    }
  }
  return records;
}
