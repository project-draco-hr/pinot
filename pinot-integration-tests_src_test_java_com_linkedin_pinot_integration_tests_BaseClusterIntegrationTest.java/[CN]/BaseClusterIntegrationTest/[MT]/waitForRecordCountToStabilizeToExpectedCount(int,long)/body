{
  int pinotRecordCount=-1;
  final long startTimeMs=System.currentTimeMillis();
  do {
    Thread.sleep(5000L);
    try {
      JSONObject response=postQuery("select count(*) from 'mytable'");
      JSONArray aggregationResultsArray=response.getJSONArray("aggregationResults");
      JSONObject firstAggregationResult=aggregationResultsArray.getJSONObject(0);
      String pinotValue=firstAggregationResult.getString("value");
      pinotRecordCount=Integer.parseInt(pinotValue);
      LOGGER.info("Pinot record count: " + pinotRecordCount + "\tExpected count: "+ expectedRecordCount);
      TOTAL_DOCS=response.getLong("totalDocs");
    }
 catch (    Exception e) {
      LOGGER.warn("Caught exception while waiting for record count to stabilize, will try again.",e);
    }
    if (expectedRecordCount != pinotRecordCount) {
      final long now=System.currentTimeMillis();
      Assert.assertTrue(now < deadlineMs,"Failed to read " + expectedRecordCount + " records within the deadline (duration "+ (deadlineMs - startTimeMs)+ "ms,NumRecords="+ pinotRecordCount);
    }
  }
 while (expectedRecordCount != pinotRecordCount);
}
