{
  long[] sums=new long[metricNames.size()];
  int[] targetDimensions=new int[dimensionNames.size()];
  for (int i=0; i < dimensionNames.size(); i++) {
    String dimensionName=dimensionNames.get(i);
    String dimensionValue=query.getDimensionValues().get(dimensionName);
    int valueId=forwardIndex.get(dimensionName).get(dimensionValue);
    targetDimensions[i]=valueId;
  }
  if (query.getTimeBuckets() != null) {
    for (    Long time : query.getTimeBuckets()) {
      int bucket=(int)(time % timeBuckets.size());
      int idx=search(buffer,bucket,targetDimensions);
      if (idx >= 0) {
        buffer.position(idx);
        updateSums(buffer,sums,time);
      }
    }
  }
 else   if (query.getTimeRange() != null) {
    for (long time=query.getTimeRange().getKey(); time <= query.getTimeRange().getValue(); time++) {
      int bucket=(int)(time % timeBuckets.size());
      int idx=search(buffer,bucket,targetDimensions);
      if (idx >= 0) {
        buffer.position(idx);
        updateSums(buffer,sums,time);
      }
    }
  }
 else {
    for (    long time : timeBuckets) {
      int bucket=(int)(time % timeBuckets.size());
      int idx=search(buffer,bucket,targetDimensions);
      if (idx >= 0) {
        buffer.position(idx);
        updateSums(buffer,sums,time);
      }
    }
  }
  return sums;
}
