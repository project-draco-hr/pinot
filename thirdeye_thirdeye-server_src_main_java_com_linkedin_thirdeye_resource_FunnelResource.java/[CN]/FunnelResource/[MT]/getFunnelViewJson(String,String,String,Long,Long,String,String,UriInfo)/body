{
  StarTreeConfig config=starTreeManager.getConfig(collection);
  if (config == null) {
    throw new NotFoundException("No collection " + collection);
  }
  Collection<StarTree> starTrees=starTreeManager.getStarTrees(collection).values();
  Funnel.Type funnelType;
  try {
    funnelType=Funnel.Type.valueOf(type.toUpperCase());
  }
 catch (  Exception e) {
    throw new NotFoundException("Unrecognized funnel type " + type);
  }
  List<String> funnelMetrics=Arrays.asList(metrics.split(","));
  if (funnelMetrics.size() < 2) {
    throw new WebApplicationException(new IllegalStateException("Funnel must specify at least two metrics: " + funnelMetrics),Response.Status.BAD_REQUEST);
  }
  MetricSpec topMetric=null;
  Map<String,MetricSpec> metricSpecs=new HashMap<String,MetricSpec>();
  for (  MetricSpec metricSpec : config.getMetrics()) {
    if (metricSpec.getName().equals(funnelMetrics.get(0))) {
      topMetric=metricSpec;
    }
    metricSpecs.put(metricSpec.getName(),metricSpec);
  }
  if (topMetric == null) {
    throw new WebApplicationException(new IllegalStateException("Baseline metric not found " + funnelMetrics.get(0)),500);
  }
  int bucketSize=config.getTime().getBucket().getSize();
  TimeUnit bucketUnit=config.getTime().getBucket().getUnit();
  Long aggregateValue="".equals(aggregate) ? null : bucketUnit.convert(Long.valueOf(aggregate.split("/")[2]),TimeUnit.MILLISECONDS) / bucketSize;
  Long movingAverageValue="".equals(movingAverage) ? null : bucketUnit.convert(Long.valueOf(movingAverage.split("/")[2]),TimeUnit.MILLISECONDS) / bucketSize;
  long start=bucketUnit.convert(startMillis,TimeUnit.MILLISECONDS) / bucketSize;
  long end=bucketUnit.convert(endMillis,TimeUnit.MILLISECONDS) / bucketSize;
  if (aggregateValue != null) {
    start=(start / aggregateValue) * aggregateValue;
    end=(end / aggregateValue) * aggregateValue;
  }
  String invalidDimension=QueryUtils.checkDimensions(config,uriInfo);
  if (invalidDimension != null) {
    throw new WebApplicationException(Response.status(Response.Status.BAD_REQUEST).header("No dimension ",invalidDimension).entity("No dimension : " + invalidDimension).build());
  }
  Map<DimensionKey,MetricTimeSeries> result;
  if (movingAverageValue == null && aggregateValue == null) {
    result=QueryUtils.doQuery(starTrees,start,end,uriInfo);
  }
 else   if (movingAverageValue != null && aggregateValue == null) {
    result=QueryUtils.doQuery(starTrees,start - movingAverageValue,end,uriInfo);
  }
 else   if (movingAverageValue == null && aggregateValue != null) {
    result=QueryUtils.doQuery(starTrees,start,end + aggregateValue,uriInfo);
  }
 else {
    result=QueryUtils.doQuery(starTrees,start - (movingAverageValue / aggregateValue) * aggregateValue,end + aggregateValue,uriInfo);
  }
  List<Funnel> funnels=new ArrayList<Funnel>();
  for (  Map.Entry<DimensionKey,MetricTimeSeries> entry : result.entrySet()) {
    List<FunnelRow> rows=new ArrayList<FunnelRow>();
    MetricTimeSeries timeSeries=entry.getValue();
    if (aggregateValue != null) {
      timeSeries=MetricTimeSeriesUtils.aggregate(timeSeries,aggregateValue,end + aggregateValue);
    }
    if (movingAverageValue != null) {
      timeSeries=MetricTimeSeriesUtils.getSimpleMovingAverage(timeSeries,start,end,movingAverageValue);
    }
    rows.add(FunnelRow.createTopRow(topMetric));
    double topStartValue=timeSeries.get(start,topMetric.getName()).doubleValue();
    double topEndValue=timeSeries.get(end,topMetric.getName()).doubleValue();
    for (int i=1; i < funnelMetrics.size(); i++) {
      MetricSpec previousMetric=metricSpecs.get(funnelMetrics.get(i - 1));
      if (previousMetric == null) {
        throw new WebApplicationException(new IllegalStateException("Metric not found " + funnelMetrics.get(i - 1)),500);
      }
      double previousStartValue=timeSeries.get(start,previousMetric.getName()).doubleValue();
      double previousEndValue=timeSeries.get(end,previousMetric.getName()).doubleValue();
      MetricSpec currentMetric=metricSpecs.get(funnelMetrics.get(i));
      if (currentMetric == null) {
        throw new WebApplicationException(new IllegalStateException("Metric not found " + funnelMetrics.get(i)),500);
      }
      double currentStartValue=timeSeries.get(start,currentMetric.getName()).doubleValue();
      double currentEndValue=timeSeries.get(end,currentMetric.getName()).doubleValue();
switch (funnelType) {
case TOP:
        double currentToTopStart=0;
      double currentToTopEnd=0;
    if (topStartValue > 0) {
      currentToTopStart=currentStartValue / topStartValue;
    }
  if (topEndValue > 0) {
    currentToTopEnd=currentEndValue / topEndValue;
  }
rows.add(new FunnelRow(currentMetric,currentToTopStart,currentToTopEnd));
break;
case PREVIOUS:
double currentToPreviousStart=0;
double currentToPreviousEnd=0;
if (previousStartValue > 0) {
currentToPreviousStart=currentStartValue / previousStartValue;
}
if (previousEndValue > 0) {
currentToPreviousEnd=currentEndValue / previousEndValue;
}
rows.add(new FunnelRow(currentMetric,currentToPreviousStart,currentToPreviousEnd));
break;
default :
throw new IllegalArgumentException("Unsupported funnel type " + type);
}
}
funnels.add(new Funnel(QueryUtils.convertDimensionKey(config.getDimensions(),entry.getKey()),rows));
}
return funnels;
}
