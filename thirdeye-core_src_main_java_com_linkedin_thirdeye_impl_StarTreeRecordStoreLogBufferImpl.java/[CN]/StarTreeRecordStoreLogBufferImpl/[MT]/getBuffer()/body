{
  if (buffer == null) {
    buffer=createBuffer(bufferSize);
    buffer.limit(0);
  }
  if (buffer.limit() + entrySize > buffer.capacity()) {
    int oldLimit=buffer.limit();
    compactBuffer(buffer);
    int newLimit=buffer.limit();
    double loadFactor=(1.0 * newLimit) / oldLimit;
    if (loadFactor > targetLoadFactor) {
      ByteBuffer expandedBuffer=createBuffer(buffer.capacity() + bufferSize);
      buffer.rewind();
      expandedBuffer.put(buffer);
      expandedBuffer.limit(expandedBuffer.position());
      int oldCapacity=buffer.capacity();
      int newCapacity=expandedBuffer.capacity();
      buffer=expandedBuffer;
      LOG.info("Expanded buffer ({}): oldCapacity={},newCapacity={}",nodeId,oldCapacity,newCapacity);
    }
 else {
      LOG.info("Compacted buffer ({}): loadFactor={},capacity={}",nodeId,loadFactor,buffer.capacity());
    }
  }
  return buffer;
}
