{
  if (buffer == null) {
    buffer=createBuffer(bufferSize);
    buffer.limit(0);
  }
  if (buffer.limit() + entrySize > buffer.capacity()) {
    int oldLimit=buffer.limit();
    compactBuffer(buffer);
    int newLimit=buffer.limit();
    double loadFactor=(1.0 * newLimit) / oldLimit;
    LOG.info("{}: compacted buffer (loadFactor={}) {}",nodeId,loadFactor,buffer);
    if (loadFactor > targetLoadFactor) {
      ByteBuffer expandedBuffer=createBuffer(buffer.capacity() + bufferSize);
      buffer.rewind();
      expandedBuffer.put(buffer);
      expandedBuffer.limit(expandedBuffer.position());
      buffer=expandedBuffer;
      LOG.info("{}: expanded buffer {}",nodeId,buffer);
    }
  }
  return buffer;
}
