{
  Set<String> dataResourceNames=admin.getResourceExternalView(clusterName,CommonConstants.Helix.BROKER_RESOURCE_INSTANCE).getPartitionSet();
  for (  String dataResourceName : dataResourceNames) {
    Map<String,String> segmentOnlineOfflineMap=admin.getResourceExternalView(clusterName,CommonConstants.Helix.BROKER_RESOURCE_INSTANCE).getStateMap(dataResourceName);
    if (segmentOnlineOfflineMap.containsKey(instanceName)) {
      if (segmentOnlineOfflineMap.get(instanceName).equals(CommonConstants.Helix.StateModel.ONLINE)) {
        throw new RuntimeException("Cannot remove broker instance from cluster, it's still ONLINE for resource: " + dataResourceName);
      }
    }
  }
  admin.dropInstance(clusterName,getInstanceConfigFor(clusterName,instanceName,admin));
}
