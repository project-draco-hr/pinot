{
  List<String> resourceNames=admin.getResourcesInCluster(clusterName);
  for (  String resourceName : resourceNames) {
    if (resourceName.equals(BROKER_RESOURCE)) {
      continue;
    }
    Set<String> segmentNames=admin.getResourceExternalView(clusterName,resourceName).getPartitionSet();
    for (    String segmentName : segmentNames) {
      Map<String,String> segmentOnlineOfflineMap=admin.getResourceExternalView(clusterName,resourceName).getStateMap(segmentName);
      if (segmentOnlineOfflineMap.containsKey(instanceName)) {
        if (segmentOnlineOfflineMap.get(instanceName).equals(CommonConstants.Helix.StateModel.ONLINE)) {
          throw new RuntimeException("Cannot remove server instance from cluster, it's still ONLINE for resource: " + resourceName + ", and segment : "+ segmentName);
        }
      }
    }
  }
  admin.dropInstance(clusterName,getInstanceConfigFor(clusterName,instanceName,admin));
}
