{
  startZk();
  startController();
  startBroker();
  startServer();
  createOfflineResource("myresource","DaysSinceEpoch","daysSinceEpoch");
  addTableToOfflineResource("myresource","mytable","DaysSinceEpoch","daysSinceEpoch");
  TarGzCompressionUtils.unTar(new File(TestUtils.getFileFromResourceUrl(OfflineClusterIntegrationTest.class.getClassLoader().getResource("On_Time_On_Time_Performance_2014_100k_subset.tar.gz"))),_tmpDir);
  _tmpDir.mkdirs();
  queriesFile=new File(TestUtils.getFileFromResourceUrl(OfflineClusterIntegrationTest.class.getClassLoader().getResource("On_Time_On_Time_Performance_2014_100k_subset.test_queries_10K")));
  final List<File> avroFiles=new ArrayList<File>(SEGMENT_COUNT);
  for (int segmentNumber=1; segmentNumber <= SEGMENT_COUNT; ++segmentNumber) {
    avroFiles.add(new File(_tmpDir.getPath() + "/On_Time_On_Time_Performance_2014_" + segmentNumber+ ".avro"));
  }
  ExecutorService executor=Executors.newCachedThreadPool();
  Class.forName("org.h2.Driver");
  _connection=DriverManager.getConnection("jdbc:h2:mem:");
  executor.execute(new Runnable(){
    @Override public void run(){
      createH2SchemaAndInsertAvroFiles(avroFiles,_connection);
    }
  }
);
  buildSegmentsFromAvro(avroFiles,executor,0,_tmpDir);
  executor.execute(new Runnable(){
    @Override public void run(){
      _queryGenerator=new QueryGenerator(avroFiles,"'myresource.mytable'","mytable");
    }
  }
);
  executor.shutdown();
  executor.awaitTermination(10,TimeUnit.MINUTES);
  final CountDownLatch latch=new CountDownLatch(1);
  HelixManager manager=HelixManagerFactory.getZKHelixManager(getHelixClusterName(),"test_instance",InstanceType.SPECTATOR,ZkTestUtils.DEFAULT_ZK_STR);
  manager.connect();
  manager.addExternalViewChangeListener(new ExternalViewChangeListener(){
    @Override public void onExternalViewChange(    List<ExternalView> externalViewList,    NotificationContext changeContext){
      for (      ExternalView externalView : externalViewList) {
        if (externalView.getId().contains("myresource")) {
          Set<String> partitionSet=externalView.getPartitionSet();
          if (partitionSet.size() == SEGMENT_COUNT) {
            int onlinePartitionCount=0;
            for (            String partitionId : partitionSet) {
              Map<String,String> partitionStateMap=externalView.getStateMap(partitionId);
              if (partitionStateMap.containsValue("ONLINE")) {
                onlinePartitionCount++;
              }
            }
            if (onlinePartitionCount == SEGMENT_COUNT) {
              System.out.println("Got " + SEGMENT_COUNT + " online resources, unlatching the main thread");
              latch.countDown();
            }
          }
        }
      }
    }
  }
);
  for (int i=1; i <= SEGMENT_COUNT; ++i) {
    System.out.println("Uploading segment " + i);
    File file=new File(_tmpDir,"myresource_mytable_" + i);
    FileUploadUtils.sendFile("localhost","8998","myresource_mytable_" + i,new FileInputStream(file),file.length());
  }
  latch.await();
  while (getCurrentServingNumDocs() < 115545) {
    Thread.sleep(1000);
  }
}
