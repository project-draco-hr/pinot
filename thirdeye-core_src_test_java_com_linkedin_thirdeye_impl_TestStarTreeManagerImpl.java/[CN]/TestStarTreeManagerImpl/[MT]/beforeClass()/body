{
  baseDir=new File(System.getProperty("java.io.tmpdir"),TestStarTreeManagerImpl.class.getSimpleName());
  collectionDir=new File(baseDir,"myCollection");
  rootDir=new File(collectionDir,"data");
  FileUtils.forceMkdir(baseDir);
  FileUtils.forceMkdir(rootDir);
  UUID nodeId=UUID.randomUUID();
  List<StarTreeRecord> records=new ArrayList<StarTreeRecord>();
  for (int i=0; i < 100; i++) {
    StarTreeRecordImpl.Builder builder=new StarTreeRecordImpl.Builder();
    builder.setDimensionValue("A","A" + (i % 2));
    builder.setDimensionValue("B","B" + (i % 4));
    builder.setDimensionValue("C","C" + (i % 8));
    builder.setMetricValue("M",1);
    builder.setMetricType("M",MetricType.INT);
    builder.setTime((long)i);
    records.add(builder.build());
  }
  int currentValueId=StarTreeConstants.FIRST_VALUE;
  Map<String,Map<String,Integer>> forwardIndex=new HashMap<String,Map<String,Integer>>();
  for (  String dimensionName : Arrays.asList("A","B","C")) {
    forwardIndex.put(dimensionName,new HashMap<String,Integer>());
    for (int i=0; i < 8; i++) {
      forwardIndex.get(dimensionName).put(dimensionName + i,currentValueId++);
    }
    forwardIndex.get(dimensionName).put(StarTreeConstants.STAR,StarTreeConstants.STAR_VALUE);
    forwardIndex.get(dimensionName).put(StarTreeConstants.OTHER,StarTreeConstants.OTHER_VALUE);
  }
  OutputStream outputStream=new FileOutputStream(new File(rootDir,nodeId + ".buf"));
  StarTreeRecordStoreCircularBufferImpl.fillBuffer(outputStream,Arrays.asList(new DimensionSpec("A"),new DimensionSpec("B"),new DimensionSpec("C")),Arrays.asList(new MetricSpec("M",MetricType.INT)),forwardIndex,records,128,true);
  outputStream.flush();
  outputStream.close();
  outputStream=new FileOutputStream(new File(rootDir,nodeId + ".idx"));
  new ObjectMapper().writeValue(outputStream,forwardIndex);
  outputStream.flush();
  outputStream.close();
  TimeSpec timeSpec=new TimeSpec("hoursSinceEpoch",new TimeGranularity(1,TimeUnit.HOURS),new TimeGranularity(1,TimeUnit.HOURS),new TimeGranularity(128,TimeUnit.HOURS));
  StarTreeConfig config=new StarTreeConfig.Builder().setCollection("myCollection").setDimensions(Arrays.asList(new DimensionSpec("A"),new DimensionSpec("B"),new DimensionSpec("C"))).setMetrics(Arrays.asList(new MetricSpec("M",MetricType.INT))).setTime(timeSpec).build();
  StarTree starTree=new StarTreeImpl(config,rootDir,new StarTreeNodeImpl(nodeId,StarTreeConstants.STAR,StarTreeConstants.STAR,new ArrayList<String>(),new HashMap<String,String>(),new HashMap<String,StarTreeNode>(),null,null));
  ObjectOutputStream objectOutputStream=new ObjectOutputStream(new FileOutputStream(new File(collectionDir,StarTreeConstants.TREE_FILE_NAME)));
  objectOutputStream.writeObject(starTree.getRoot());
  objectOutputStream.flush();
  objectOutputStream.close();
  outputStream=new FileOutputStream(new File(collectionDir,StarTreeConstants.CONFIG_FILE_NAME));
  outputStream.write(config.encode().getBytes());
  outputStream.flush();
  outputStream.close();
}
