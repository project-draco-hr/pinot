{
  if (skipMaterializationForDimensions == null || skipMaterializationForDimensions.isEmpty()) {
    skipMaterializationForDimensions=computeDefaultDimensionsToSkipMaterialization();
  }
  if (dimensionsSplitOrder == null || dimensionsSplitOrder.isEmpty()) {
    dimensionsSplitOrder=computeDefaultSplitOrder();
  }
  dimensionsSplitOrder=sanitizeSplitOrder(dimensionsSplitOrder,skipMaterializationForDimensions);
  LOG.debug("Split order:{}",dimensionsSplitOrder);
  long start=System.currentTimeMillis();
  dataBuffer.flush();
  sort(dataFile,0,rawRecordCount);
  constructStarTree(starTreeRootIndexNode,0,rawRecordCount,0,dataFile);
  if (timeColumnName != null && !skipMaterializationForDimensions.contains(timeColumnName) && !dimensionsSplitOrder.contains(timeColumnName)) {
    splitLeafNodesOnTimeColumn();
  }
  createAggDocForAllNodes(starTreeRootIndexNode);
  long end=System.currentTimeMillis();
  LOG.debug("Took {} ms to build star tree index. Original records:{} Materialized record:{}",(end - start),rawRecordCount,aggRecordCount);
  starTree=new StarTree(starTreeRootIndexNode,dimensionNameToIndexMap);
  File treeBinary=new File(outDir,"star-tree.bin");
  LOG.debug("Saving tree binary at: {} ",treeBinary);
  starTree.writeTree(new BufferedOutputStream(new FileOutputStream(treeBinary)));
  printTree(starTreeRootIndexNode,0);
  LOG.debug("Finished build tree. out dir: {} ",outDir);
  dataBuffer.close();
}
