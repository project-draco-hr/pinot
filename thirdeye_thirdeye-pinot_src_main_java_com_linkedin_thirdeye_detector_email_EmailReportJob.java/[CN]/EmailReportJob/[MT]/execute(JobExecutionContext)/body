{
  final EmailConfiguration config=(EmailConfiguration)context.getJobDetail().getJobDataMap().get(CONFIG);
  final FailureEmailConfiguration failureEmailConfig=(FailureEmailConfiguration)context.getJobDetail().getJobDataMap().get(FAILURE_EMAIL_CONFIG_KEY);
  try {
    run(context,config);
  }
 catch (  Throwable t) {
    LOG.error("Job failed with exception:",t);
    long id=config.getId();
    String collection=config.getCollection();
    String metric=config.getMetric();
    String subject=String.format("FAILED ALERT ID=%d (%s:%s)",id,collection,metric);
    String textBody=String.format("%s%n%nException:%s",config.toString(),ExceptionUtils.getStackTrace(t));
    try {
      JobUtils.sendFailureEmail(failureEmailConfig,subject,textBody);
    }
 catch (    EmailException e) {
      throw new JobExecutionException(e);
    }
  }
}
