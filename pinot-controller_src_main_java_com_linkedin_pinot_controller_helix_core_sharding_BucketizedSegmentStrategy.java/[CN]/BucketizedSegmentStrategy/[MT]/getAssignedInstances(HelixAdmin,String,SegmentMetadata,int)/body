{
  String resourceName=null;
  if ("realtime".equalsIgnoreCase(segmentMetadata.getIndexType())) {
    resourceName=BrokerRequestUtils.getRealtimeResourceNameForResource(segmentMetadata.getResourceName());
  }
 else {
    resourceName=BrokerRequestUtils.getOfflineResourceNameForResource(segmentMetadata.getResourceName());
  }
  List<String> allInstances=helixAdmin.getInstancesInClusterWithTag(helixClusterName,resourceName);
  List<String> selectedInstanceList=new ArrayList<String>();
  if (segmentMetadata.getShardingKey() != null) {
    for (    String instance : allInstances) {
      if (HelixHelper.getInstanceConfigsMapFor(instance,helixClusterName,helixAdmin).get("shardingKey").equalsIgnoreCase(segmentMetadata.getShardingKey())) {
        selectedInstanceList.add(instance);
      }
    }
    LOGGER.info("Segment assignment result for : " + segmentMetadata.getName() + ", in resource : "+ segmentMetadata.getResourceName()+ ", selected instances: "+ Arrays.toString(selectedInstanceList.toArray()));
    return selectedInstanceList;
  }
 else {
    throw new RuntimeException("Segment missing sharding key!");
  }
}
