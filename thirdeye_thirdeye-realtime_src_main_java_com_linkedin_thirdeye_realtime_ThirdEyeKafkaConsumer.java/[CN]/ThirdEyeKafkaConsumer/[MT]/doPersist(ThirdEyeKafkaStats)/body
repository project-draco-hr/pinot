{
  persistLock.writeLock().lock();
  try {
    long persistTime=System.currentTimeMillis();
    DateTime minTime=new DateTime(stats.getLastPersistTimeMillis().get());
    DateTime maxTime=new DateTime(persistTime);
    if (tmpMetricStoreDirectory.exists()) {
      FileUtils.forceDelete(tmpMetricStoreDirectory);
    }
    ThirdEyeKafkaPersistenceUtils.persistMetrics(starTree,tmpMetricStoreDirectory);
    prefixFilesWithTime(tmpMetricStoreDirectory,minTime,maxTime,schedule);
    moveAllFiles(tmpMetricStoreDirectory,metricStoreDirectory);
    if (tmpMetricStoreDirectory.exists()) {
      FileUtils.forceDelete(tmpMetricStoreDirectory);
    }
    stats.getLastPersistTimeMillis().set(persistTime);
    starTree.clear();
    if (!kafkaDataDir.setLastModified(stats.getLastPersistTimeMillis().get())) {
      LOG.warn("Could not trigger watch on collection dir {}",kafkaDataDir.getParentFile());
    }
  }
 catch (  Exception e) {
    LOG.error("Error persisting data from Kafka",e);
  }
 finally {
    persistLock.writeLock().unlock();
  }
}
