{
  String collection=starTreeConfig.getCollection();
  long currentTime=System.currentTimeMillis();
  DateTime minTime=new DateTime(stats.getLastPersistTimeMillis().get(),DateTimeZone.UTC);
  DateTime maxTime=new DateTime(currentTime,DateTimeZone.UTC);
  TimeGranularity scheduleGranularity=kafkaConfig.getPersistInterval();
  String schedule=String.format("KAFKA-%d-%s",scheduleGranularity.getSize(),scheduleGranularity.getUnit());
  LOG.info("Beginning persist data from {} to {} for {}",minTime,maxTime,collection);
  lock.writeLock().lock();
  try {
    LOG.info("Locked {} to persist data...",lock);
    dataUpdateManager.persistTree(collection,schedule,minTime,maxTime,starTree);
    LOG.info("Clearing existing star tree metrics...");
    starTree.clear();
    LOG.info("Updating last persist time to {}",currentTime);
    stats.getLastPersistTimeMillis().set(currentTime);
    LOG.info("Committing offsets to Kafka for {}",collection);
    consumer.commitOffsets();
    LOG.info("Successfully persisted data from {} to {} for {}",minTime,maxTime,collection);
  }
 catch (  Exception e) {
    LOG.error("Could not persist star tree for {}",collection,e);
  }
 finally {
    lock.writeLock().unlock();
    LOG.info("Unlocked {}",lock);
  }
}
