{
  String collection=starTreeConfig.getCollection();
  try {
    long currentTime=System.currentTimeMillis();
    TimeGranularity scheduleGranularity=kafkaConfig.getPersistInterval();
    String schedule=String.format("KAFKA-%d-%s",scheduleGranularity.getSize(),scheduleGranularity.getUnit());
    DateTime minTime=new DateTime(stats.getLastPersistTimeMillis().get(),DateTimeZone.UTC);
    DateTime maxTime=new DateTime(currentTime,DateTimeZone.UTC);
    LOG.info("Beginning persist data from {} to {} for {}",minTime,maxTime,collection);
    lock.writeLock().lock();
    try {
      dataUpdateManager.persistTree(collection,schedule,minTime,maxTime,starTree);
      starTree.clear();
      stats.getLastPersistTimeMillis().set(currentTime);
      LOG.info("Successfully persisted data from {} to {} for {}",minTime,maxTime,collection);
      consumer.commitOffsets();
    }
  finally {
      lock.writeLock().unlock();
    }
  }
 catch (  Exception e) {
    LOG.error("Could not persist star tree",collection,e);
  }
}
