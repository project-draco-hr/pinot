{
  StarTreeNode node=find(root,query);
  if (node == null) {
    throw new IllegalArgumentException("No star tree node for query " + query);
  }
  Number[] sums=node.getRecordStore().getMetricSums(query);
  StarTreeRecordImpl.Builder result=new StarTreeRecordImpl.Builder();
  for (  Map.Entry<String,String> entry : query.getDimensionValues().entrySet()) {
    if (node.getDimensionName().equals(entry.getKey())) {
      String dimensionValue=node.getDimensionValue().equals(StarTreeConstants.OTHER) ? StarTreeConstants.OTHER : entry.getValue();
      result.setDimensionValue(entry.getKey(),dimensionValue);
    }
 else     if (node.getAncestorDimensionValues().containsKey(entry.getKey())) {
      String dimensionValue=node.getAncestorDimensionValues().get(entry.getKey());
      result.setDimensionValue(entry.getKey(),StarTreeConstants.OTHER.equals(dimensionValue) ? StarTreeConstants.OTHER : entry.getValue());
    }
 else {
      result.setDimensionValue(entry.getKey(),entry.getValue());
    }
  }
  int idx=0;
  for (int i=0; i < config.getMetrics().size(); i++) {
    String metricName=config.getMetrics().get(i).getName();
    result.setMetricValue(metricName,sums[idx++]);
    result.setMetricType(metricName,config.getMetrics().get(i).getType());
  }
  return result.build();
}
