{
  if (node.isLeaf()) {
    node.getRecordStore().update(record);
    LOG.info("Added record:{} to node:{}",record.getDimensionValues().values(),node.getAncestorDimensionValues().toString() + ", " + node.getDimensionValue());
    if (shouldSplit(node)) {
synchronized (node) {
        if (shouldSplit(node)) {
          Set<String> blacklist=new HashSet<String>();
          blacklist.addAll(node.getAncestorDimensionNames());
          blacklist.add(node.getDimensionName());
          String splitDimensionName=null;
          if (config.getSplitOrder() == null) {
            splitDimensionName=node.getRecordStore().getMaxCardinalityDimension(blacklist);
          }
 else {
            for (            String dimensionName : config.getSplitOrder()) {
              if (!blacklist.contains(dimensionName)) {
                splitDimensionName=dimensionName;
                break;
              }
            }
          }
          if (splitDimensionName != null) {
            node.split(splitDimensionName);
          }
        }
      }
    }
  }
 else {
    String dimensionValue=record.getDimensionValues().get(node.getChildDimensionName());
    StarTreeNode target=node.getChild(dimensionValue);
    if (target == null) {
      boolean mapToOtherNode=false;
      if (mapToOtherNode) {
        target=node.getOtherNode();
        String otherDimensionNames=node.getChildDimensionName();
        StarTreeRecord aliasOtherRecord=record.aliasOther(otherDimensionNames);
        add(target,aliasOtherRecord);
      }
 else {
        target=node.addChildNode(dimensionValue);
        add(target,record);
      }
    }
 else {
      add(target,record);
    }
    add(node.getStarNode(),record.relax(target.getDimensionName()));
  }
}
