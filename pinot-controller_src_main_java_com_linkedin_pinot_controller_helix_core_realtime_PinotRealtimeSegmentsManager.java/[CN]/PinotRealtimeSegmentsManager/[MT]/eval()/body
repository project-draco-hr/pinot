{
  Map<String,IdealState> idealStateMap=new HashMap<String,IdealState>();
  for (  String resource : pinotClusterManager.getAllRealtimeTables()) {
    idealStateMap.put(resource,pinotClusterManager.getHelixAdmin().getResourceIdealState(pinotClusterManager.getHelixClusterName(),resource));
  }
  List<String> listOfSegmentsToAdd=new ArrayList<String>();
  for (  String resource : idealStateMap.keySet()) {
    IdealState state=idealStateMap.get(resource);
    if (state.getPartitionSet().size() == 0) {
      List<String> instancesInResource=new ArrayList<String>();
      try {
        instancesInResource.addAll(pinotClusterManager.getServerInstancesForTable(resource,TableType.REALTIME));
      }
 catch (      Exception e) {
        LOGGER.error("error fetching instances",e);
      }
      for (      String instanceId : instancesInResource) {
        InstanceZKMetadata instanceZKMetadata=pinotClusterManager.getInstanceZKMetadata(instanceId);
        String groupId=instanceZKMetadata.getGroupId(resource);
        String partitionId=instanceZKMetadata.getPartition(resource);
        listOfSegmentsToAdd.add(SegmentNameBuilder.Realtime.build(resource,instanceId,groupId,partitionId,String.valueOf(System.currentTimeMillis())));
      }
    }
 else {
      Set<String> instancesToAssignRealtimeSegment=new HashSet<String>();
      instancesToAssignRealtimeSegment.addAll(pinotClusterManager.getHelixAdmin().getInstancesInClusterWithTag(pinotClusterManager.getHelixClusterName(),resource));
      for (      String partition : state.getPartitionSet()) {
        RealtimeSegmentZKMetadata realtimeSegmentZKMetadata=ZKMetadataProvider.getRealtimeSegmentZKMetadata(pinotClusterManager.getPropertyStore(),SegmentNameBuilder.Realtime.extractTableName(partition),partition);
        if (realtimeSegmentZKMetadata.getStatus() == Status.IN_PROGRESS) {
          String instanceName=SegmentNameBuilder.Realtime.extractInstanceName(partition);
          instancesToAssignRealtimeSegment.remove(instanceName);
        }
      }
      for (      String instanceId : instancesToAssignRealtimeSegment) {
        InstanceZKMetadata instanceZKMetadata=pinotClusterManager.getInstanceZKMetadata(instanceId);
        String groupId=instanceZKMetadata.getGroupId(resource);
        String partitionId=instanceZKMetadata.getPartition(resource);
        listOfSegmentsToAdd.add(SegmentNameBuilder.Realtime.build(resource,instanceId,groupId,partitionId,String.valueOf(System.currentTimeMillis())));
      }
    }
  }
  LOGGER.info("computed list of new segments to add : " + Arrays.toString(listOfSegmentsToAdd.toArray()));
  for (  String segmentId : listOfSegmentsToAdd) {
    String resourceName=SegmentNameBuilder.Realtime.extractTableName(segmentId);
    String instanceName=SegmentNameBuilder.Realtime.extractInstanceName(segmentId);
    if (!idealStateMap.get(resourceName).getPartitionSet().contains(segmentId)) {
      RealtimeSegmentZKMetadata realtimeSegmentMetadataToAdd=new RealtimeSegmentZKMetadata();
      realtimeSegmentMetadataToAdd.setTableName(TableNameBuilder.extractRawTableName(resourceName));
      realtimeSegmentMetadataToAdd.setSegmentType(SegmentType.REALTIME);
      realtimeSegmentMetadataToAdd.setStatus(Status.IN_PROGRESS);
      realtimeSegmentMetadataToAdd.setSegmentName(segmentId);
      ZKMetadataProvider.setRealtimeSegmentZKMetadata(pinotClusterManager.getPropertyStore(),realtimeSegmentMetadataToAdd);
      IdealState s=PinotTableIdealStateBuilder.addNewRealtimeSegmentToIdealState(segmentId,idealStateMap.get(resourceName),instanceName);
      pinotClusterManager.getHelixAdmin().setResourceIdealState(pinotClusterManager.getHelixClusterName(),resourceName,PinotTableIdealStateBuilder.addNewRealtimeSegmentToIdealState(segmentId,s,instanceName));
    }
  }
}
